<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="icon" href="#">
<title>Unsupervised Learning | Ramin Tawab Résumé</title>
<link rel="shortcut icon" type="image/png" href="../files/favicon.ico"/>
<!-- I wrote this page with the help of the Bootstrap libraries -->
<link href="../css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../css/style.css">
<link href="../css/album.css" rel="stylesheet">
<style>
img {
display: block;
margin-left: auto;
margin-right: auto;
}
.accordion {
display: block;
margin-left: auto;
margin-right: auto;
}
button {
text-decoration: none !important;
white-space: normal !important;
}
    
    #player {
        margin-left: auto !important;
        margin-right: auto !important;
    }
</style>
<script type="text/javascript"> 
function scroll(element){   
var ele = document.getElementById(element);   
window.scrollTo(ele.offsetLeft,ele.offsetTop); 
}
</script>
</head>

<body>
<nav>
<ul>
<li><a href="../index.html">Home</a></li>
<li><a href="../files/CV.pdf">CV</a></li>
<li><a href="../index.html#blog" style="cursor: pointer; color: #999;">Blog</a></li>
<li><a href="../index.html#portfolio" style="cursor: pointer; color: #999;">Portfolio</a></li>
</ul>
</nav>

<main role="main">
<section class="jumbotron text-center">
    <div class="container">
        <h1 class="jumbotron-heading">Unsupervised Machine Learning</h1>
        <p class="lead text-muted">
            This page shows my applications of K-means clustering, PCA, t-SNE and NMF to real world data.
        </p>
    </div>
</section>
<div class="album py-5">
    <div class="container">
        <div>
            <div class="accordion" id="accordionExample">
            
                <div class="card">
                        <div class="card-header" id="headingOne">
                            <h5 class="mb-0">
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                Applying principal component analysis to financial stock portfolio management
                                </button>
                            </h5>
                        </div>
                        <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionExample">
                            <div class="card-body">
                                <p style="font-weight:bold;">The Problem:</p>
                                <p>Investors in the stock market wish to diversify the stock portfolios they invest into so as to minimise risk. This notion can be formalised through principal component analysis. The principal component of a dataset represents the direction of maximum variation of the data. It is an eigenvalue of the covariance matrix, which is why stock portfolios arrived at through PCA are called eigen-portfolios.</p><p>Intuitively, principal component analysis eliminates much of the risk of the data. My task was to produce a Python implementation of this by considering the S&P 500 index.</p>
                                <p style="font-weight:bold;">The Code:</p>
                                
                                <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #408080; font-style: italic"># -*- coding: utf-8 -*-</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">Created on Wed May 03 14:13:03 2017</span>

<span style="color: #BA2121; font-style: italic">@author: Ramin Tawab</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">pandas</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">pd</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">datetime</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">dt</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">matplotlib.patches</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">mpatches</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">getReturns</span>(tickers):
    <span style="color: #BA2121">&#39;Get dataset of stock tickers in S&amp;P 500 and compute returns dataframe&#39;</span>
    data  <span style="color: #666666">=</span> pd<span style="color: #666666">.</span>read_csv(<span style="color: #BA2121">u&#39;C:/Users/user/Downloads/all_stocks_5yr.csv&#39;</span>,
                        index_col <span style="color: #666666">=</span> <span style="color: #666666">0</span>)
    df <span style="color: #666666">=</span> pd<span style="color: #666666">.</span>DataFrame(data)
    df <span style="color: #666666">=</span> df[[<span style="color: #BA2121">&#39;close&#39;</span>,<span style="color: #BA2121">&#39;Name&#39;</span>]]<span style="color: #666666">.</span>pivot(columns<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Name&#39;</span>, values<span style="color: #666666">=</span><span style="color: #BA2121">&#39;close&#39;</span>)
    df <span style="color: #666666">=</span> df[tickers]
    df <span style="color: #666666">=</span> df<span style="color: #666666">.</span>dropna()
    df<span style="color: #666666">.</span>index <span style="color: #666666">=</span> pd<span style="color: #666666">.</span>to_datetime(df<span style="color: #666666">.</span>index)
    t0 <span style="color: #666666">=</span> dt<span style="color: #666666">.</span>datetime(<span style="color: #666666">2015</span>, <span style="color: #666666">1</span>, <span style="color: #666666">1</span>)
    t1 <span style="color: #666666">=</span> dt<span style="color: #666666">.</span>datetime(<span style="color: #666666">2017</span>, <span style="color: #666666">1</span>, <span style="color: #666666">1</span>)
    df <span style="color: #666666">=</span> df<span style="color: #666666">.</span>loc[t0:t1,:]
    <span style="color: #008000; font-weight: bold">return</span> df<span style="color: #666666">.</span>pct_change()<span style="color: #666666">.</span>iloc[<span style="color: #666666">1</span>:,:]

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">getEigenPortfolio</span>(returns, test):
    <span style="color: #BA2121">&#39;Calculate investment weights for list of tickers using PCA&#39;</span>
    in_sample <span style="color: #666666">=</span> returns<span style="color: #666666">.</span>iloc[: <span style="color: #008000">int</span>(returns<span style="color: #666666">.</span>shape[<span style="color: #666666">0</span>] <span style="color: #666666">*</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> test)), : ]
    covariance_matrix <span style="color: #666666">=</span> in_sample<span style="color: #666666">.</span>cov()
    eigenval, eigenvec <span style="color: #666666">=</span> np<span style="color: #666666">.</span>linalg<span style="color: #666666">.</span>eigh(covariance_matrix)
    eigenportfolio <span style="color: #666666">=</span> eigenvec[:,<span style="color: #666666">-1</span>] <span style="color: #666666">/</span> np<span style="color: #666666">.</span>sum(eigenvec[:,<span style="color: #666666">-1</span>])
    eigenportfolio <span style="color: #666666">=</span> pd<span style="color: #666666">.</span>DataFrame(data<span style="color: #666666">=</span>eigenportfolio, 
                                    columns<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;Investment weight&#39;</span>], index<span style="color: #666666">=</span>returns<span style="color: #666666">.</span>columns)
    <span style="color: #008000; font-weight: bold">return</span> eigenportfolio

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plotEigenportfolio</span>(eigenportfolio):
    <span style="color: #BA2121">&#39;Plot the investment weights specified by the eigenportfolio&#39;</span>
    plt<span style="color: #666666">.</span>figure()
    eigenportfolio<span style="color: #666666">.</span>plot(kind<span style="color: #666666">=</span><span style="color: #BA2121">&#39;bar&#39;</span>, color<span style="color: #666666">=</span><span style="color: #BA2121">&#39;purple&#39;</span>, legend<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;Maximal eigenvalue stock portfolio&#39;</span>)
    plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;Investment weight&#39;</span>)
    plt<span style="color: #666666">.</span>xticks(rotation<span style="color: #666666">=30</span>)
    plt<span style="color: #666666">.</span>show()
    <span style="color: #008000; font-weight: bold">return</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plotCumulativeReturns</span>(returns, eigenportfolio, test):
    <span style="color: #BA2121">&#39;Plot the cumulative returns of the eigenportfolio computed from a test period&#39;</span>
    plt<span style="color: #666666">.</span>figure()
    i0 <span style="color: #666666">=</span> np<span style="color: #666666">.</span>arange(<span style="color: #666666">0</span>, (<span style="color: #008000">int</span>(returns<span style="color: #666666">.</span>shape[<span style="color: #666666">0</span>] <span style="color: #666666">*</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> test)) <span style="color: #666666">+</span> <span style="color: #666666">1</span>))
    i1 <span style="color: #666666">=</span> np<span style="color: #666666">.</span>arange((<span style="color: #008000">int</span>(returns<span style="color: #666666">.</span>shape[<span style="color: #666666">0</span>] <span style="color: #666666">*</span> (<span style="color: #666666">1</span> <span style="color: #666666">-</span> test)) <span style="color: #666666">+</span> <span style="color: #666666">1</span>), returns<span style="color: #666666">.</span>shape[<span style="color: #666666">0</span>])
    x0 <span style="color: #666666">=</span> returns<span style="color: #666666">.</span>index[:<span style="color: #008000">len</span>(i0)]
    x1 <span style="color: #666666">=</span> returns<span style="color: #666666">.</span>index[<span style="color: #008000">len</span>(i0):]
    cumulative_returns <span style="color: #666666">=</span> (((<span style="color: #666666">1</span> <span style="color: #666666">+</span> returns)<span style="color: #666666">.</span>cumprod(axis <span style="color: #666666">=</span> <span style="color: #666666">0</span>)) <span style="color: #666666">-</span> <span style="color: #666666">1</span>)<span style="color: #666666">.</span>dot(eigenportfolio)<span style="color: #666666">.</span>values
    plt<span style="color: #666666">.</span>plot(x0,cumulative_returns[i0], <span style="color: #BA2121">&#39;green&#39;</span>)
    plt<span style="color: #666666">.</span>plot(x1,cumulative_returns[i1], <span style="color: #BA2121">&#39;purple&#39;</span>)
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;Eigenportfolio Returns&#39;</span>)
    plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;Time&#39;</span>)
    plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;Cumulative Returns&#39;</span>)
    plt<span style="color: #666666">.</span>xticks(rotation<span style="color: #666666">=30</span>)
    patch_1 <span style="color: #666666">=</span> mpatches<span style="color: #666666">.</span>Patch(color<span style="color: #666666">=</span><span style="color: #BA2121">&#39;green&#39;</span>, label<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Training Set&#39;</span>)
    patch_2 <span style="color: #666666">=</span> mpatches<span style="color: #666666">.</span>Patch(color<span style="color: #666666">=</span><span style="color: #BA2121">&#39;purple&#39;</span>, label<span style="color: #666666">=</span><span style="color: #BA2121">&#39;Testing Set&#39;</span>)
    plt<span style="color: #666666">.</span>legend(handles<span style="color: #666666">=</span>[patch_1,patch_2], loc<span style="color: #666666">=0</span>)
    plt<span style="color: #666666">.</span>show()
    <span style="color: #008000; font-weight: bold">return</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">plotExample</span>(returns, ticker):
    <span style="color: #BA2121">&#39;Plot a single ticker value over the time range to compare to Eigenportfolio&#39;</span>
    plt<span style="color: #666666">.</span>figure()
    plt<span style="color: #666666">.</span>plot(((( <span style="color: #666666">1</span> <span style="color: #666666">+</span> returns<span style="color: #666666">.</span>loc[:,<span style="color: #BA2121">&#39;AAPL&#39;</span>])<span style="color: #666666">.</span>cumprod(axis <span style="color: #666666">=</span> <span style="color: #666666">0</span>)) <span style="color: #666666">-</span> <span style="color: #666666">1</span>))
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;AAPL&#39;</span>)
    plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;Time&#39;</span>)
    plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;Cumulative Returns&#39;</span>)
    plt<span style="color: #666666">.</span>xticks(rotation<span style="color: #666666">=30</span>)
    plt<span style="color: #666666">.</span>show()
    <span style="color: #008000; font-weight: bold">return</span>
    
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    <span style="color: #BA2121">&#39;Main function of the program&#39;</span>
    <span style="color: #408080; font-style: italic"># tickers for which to develop an investment strategy</span>
    tickers <span style="color: #666666">=</span> [<span style="color: #BA2121">&#39;GOOG&#39;</span>, <span style="color: #BA2121">&#39;AAPL&#39;</span>, <span style="color: #BA2121">&#39;MSFT&#39;</span>,<span style="color: #BA2121">&#39;WDC&#39;</span>,<span style="color: #BA2121">&#39;KLAC&#39;</span>,<span style="color: #BA2121">&#39;AMZN&#39;</span>, <span style="color: #BA2121">&#39;CERN&#39;</span>]
    <span style="color: #408080; font-style: italic"># fraction of datapoints to use in testing set</span>
    test <span style="color: #666666">=</span> <span style="color: #666666">0.50</span>
    <span style="color: #408080; font-style: italic"># calculate the returns and eigenportfolio</span>
    returns <span style="color: #666666">=</span> getReturns(tickers)
    eigenportfolio <span style="color: #666666">=</span> getEigenPortfolio(returns, test)
    <span style="color: #408080; font-style: italic"># plot three graphs</span>
    plotEigenportfolio(eigenportfolio)
    plotCumulativeReturns(returns, eigenportfolio, test)
    plotExample(returns, <span style="color: #BA2121">&#39;AAPL&#39;</span>)
    <span style="color: #008000; font-weight: bold">return</span>

main()
</pre></div><br>

                                
                                <p style="font-weight:bold;">The Solution:</p>
                                <p>The assigned weights by the principal component eigenvector produce the following stock portfolio:</p>
                                <img src="../files/UnsupervisedLearning/stockPortfolio.png" style="width:60%">
                                <p>The cumulative returns of following such a strategy are shown:</p>
                                <img src="../files/UnsupervisedLearning/portfolioReturns.png" style="width:60%">
                                <p>As a comparison, here are the cumulative returns of Apple's stocks over the same time period:</p>
                                <img src="../files/UnsupervisedLearning/aaplReturns.png" style="width:60%">
                                <p>Apple's returns are more volatile and yield less than those of the stock portfolion. The program works as hoped. There are improvements that can be made but this was a short project that has met its goals.</p>
                            </div>
                        </div>
                            <div class="card-header" id="headingTwo">
                            <h5 class="mb-0">
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                K-means clustering and t-SNE embedding high dimensional poverty dataset
                                </button>
                            </h5>
                        </div>
                        <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionExample">
                            <div class="card-body">
                                <p style="font-weight:bold;">The Problem:</p>
                                <p>The Oxford Poverty & Human Development Initiative holds a Multidimensional Poverty Measures dataset. To focus charitable efforts, it is neccessary to cluster different regions of the world into different levels of importance. Doing this precisely and informatively is a difficult task.</p>
                                <p style="font-weight:bold;">The Code:</p>
                                <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #408080; font-style: italic"># -*- coding: utf-8 -*-</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">Created on Fri May 05 21:01:52 2017</span>

<span style="color: #BA2121; font-style: italic">@author: Ramin Tawab</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">pandas</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">pd</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">numpy</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">np</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.cluster</span> <span style="color: #008000; font-weight: bold">import</span> KMeans
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">matplotlib.pyplot</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">plt</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.manifold</span> <span style="color: #008000; font-weight: bold">import</span> TSNE
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.preprocessing</span> <span style="color: #008000; font-weight: bold">import</span> StandardScaler

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">getFile</span>():
    <span style="color: #BA2121">&#39;fetch the dataset and parse as dataframe&#39;</span>
    data <span style="color: #666666">=</span> pd<span style="color: #666666">.</span>read_csv(<span style="color: #BA2121">&#39;C:/Users/user/Downloads/poverty.csv&#39;</span>)
    df <span style="color: #666666">=</span> pd<span style="color: #666666">.</span>DataFrame(data)
    df <span style="color: #666666">=</span> df[[<span style="color: #BA2121">&#39;MPI Urban&#39;</span>,<span style="color: #BA2121">&#39;Headcount Ratio Urban&#39;</span>,
    <span style="color: #BA2121">&#39;Intensity of Deprivation Urban&#39;</span>, <span style="color: #BA2121">&#39;MPI Rural&#39;</span>, 
    <span style="color: #BA2121">&#39;Headcount Ratio Rural&#39;</span>, <span style="color: #BA2121">&#39;Intensity of Deprivation Rural&#39;</span>]]
    <span style="color: #008000; font-weight: bold">return</span> df

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">elbowMethod</span>(df):
    <span style="color: #BA2121">&#39;plot to determine the optimal number of clusters in the dataset&#39;</span>
    inertias <span style="color: #666666">=</span> []
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">1</span>,<span style="color: #666666">10</span>):    
        kmeans <span style="color: #666666">=</span> KMeans(n_clusters<span style="color: #666666">=</span>i,random_state<span style="color: #666666">=0</span>)<span style="color: #666666">.</span>fit(df<span style="color: #666666">.</span>values)
        inertias<span style="color: #666666">.</span>append(kmeans<span style="color: #666666">.</span>inertia_)
    plt<span style="color: #666666">.</span>figure()
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;Inertias of dataset through different cluster sizes&#39;</span>)
    plt<span style="color: #666666">.</span>xlabel(<span style="color: #BA2121">&#39;Cluster size&#39;</span>)
    plt<span style="color: #666666">.</span>ylabel(<span style="color: #BA2121">&#39;Inertia&#39;</span>)
    plt<span style="color: #666666">.</span>plot(<span style="color: #008000">range</span>(<span style="color: #666666">1</span>,<span style="color: #666666">10</span>),inertias)
    plt<span style="color: #666666">.</span>show()
    <span style="color: #008000; font-weight: bold">return</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">cluster</span>(df):
    <span style="color: #BA2121">&#39;K-means cluster the data&#39;</span>
    scaler <span style="color: #666666">=</span> StandardScaler()
    data <span style="color: #666666">=</span> scaler<span style="color: #666666">.</span>fit(df<span style="color: #666666">.</span>values)
    data <span style="color: #666666">=</span> scaler<span style="color: #666666">.</span>transform(df<span style="color: #666666">.</span>values)
    kmeans <span style="color: #666666">=</span> KMeans(n_clusters<span style="color: #666666">=4</span>,random_state<span style="color: #666666">=0</span>)<span style="color: #666666">.</span>fit(data)
    <span style="color: #008000; font-weight: bold">return</span> kmeans<span style="color: #666666">.</span>labels_

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">embed</span>(df, c):
    <span style="color: #BA2121">&#39;construct embedded plot of the dataframe using t-SNE&#39;</span>
    model <span style="color: #666666">=</span> TSNE(learning_rate<span style="color: #666666">=100</span>)
    transformed <span style="color: #666666">=</span> model<span style="color: #666666">.</span>fit_transform(df<span style="color: #666666">.</span>values)
    plt<span style="color: #666666">.</span>figure()
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">4</span>):
        t <span style="color: #666666">=</span> [transformed[j] <span style="color: #008000; font-weight: bold">for</span> j <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #008000">len</span>(transformed)) <span style="color: #008000; font-weight: bold">if</span> c[j] <span style="color: #666666">==</span> i]
        xs <span style="color: #666666">=</span> [e[<span style="color: #666666">0</span>] <span style="color: #008000; font-weight: bold">for</span> e <span style="color: #AA22FF; font-weight: bold">in</span> t]
        ys <span style="color: #666666">=</span> [e[<span style="color: #666666">1</span>] <span style="color: #008000; font-weight: bold">for</span> e <span style="color: #AA22FF; font-weight: bold">in</span> t]
        plt<span style="color: #666666">.</span>scatter(xs,ys,c<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;red&#39;</span>,<span style="color: #BA2121">&#39;green&#39;</span>,<span style="color: #BA2121">&#39;blue&#39;</span>,<span style="color: #BA2121">&#39;black&#39;</span>][i],label<span style="color: #666666">=</span><span style="color: #008000">str</span>(i))        
    plt<span style="color: #666666">.</span>title(<span style="color: #BA2121">&#39;t-SNE embedding of clusters&#39;</span>)
    plt<span style="color: #666666">.</span>legend(loc<span style="color: #666666">=0</span>)
    plt<span style="color: #666666">.</span>show()
    <span style="color: #008000; font-weight: bold">return</span>
    
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">summariseClusters</span>(df,c): 
    <span style="color: #BA2121">&#39;summary dataframe of clusters aggregated via mean&#39;</span>
    df[<span style="color: #BA2121">&#39;cluster&#39;</span>] <span style="color: #666666">=</span> c
    Df <span style="color: #666666">=</span> df<span style="color: #666666">.</span>groupby(<span style="color: #BA2121">&#39;cluster&#39;</span>)<span style="color: #666666">.</span>agg(np<span style="color: #666666">.</span>mean)
    <span style="color: #008000; font-weight: bold">return</span> Df

    
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>():
    <span style="color: #BA2121">&#39;main function to run&#39;</span>
    <span style="color: #408080; font-style: italic"># Get the File</span>
    df <span style="color: #666666">=</span> getFile()
    <span style="color: #408080; font-style: italic"># Use the elbow method to find ideal cluster size of four</span>
    elbowMethod(df)
    <span style="color: #408080; font-style: italic"># Cluster the dataset</span>
    cl <span style="color: #666666">=</span> cluster(df)
    <span style="color: #408080; font-style: italic"># Embed the dataset and visualise the clusters</span>
    embed(df, cl)
    <span style="color: #408080; font-style: italic"># Summarise the clusters by aggregating the members through a mean</span>
    <span style="color: #008000">print</span>(summariseClusters(df, cl))
    
main()
</pre></div>
<br>
                                <p style="font-weight:bold;">The Solution:</p>
                                <p>The dataset needs to be partitioned into clusters through the K-means clustering algorithm. The optimal number of clusters can be determined through a tradeoff between minimising the inertia of the clustering and minimising the number of clusters. The elbow method is a heuristic that tells us to select the cluster corresponding to the last vertex of the cluster-inertia graph. Here, this corresponds to four clusters:</p>
<img src="../files/UnsupervisedLearning/inertia.png" style="width:60%;border:1px solid black;"><br>
                                <p>Next, we visualise the success of the clustering by embedding the high dimensional dataset into two dimensional real space using t-distributed neighbourhood embedding, t-SNE. This preserves the closeness between the points:</p>
                                <img src="../files/UnsupervisedLearning/tsne.png" style="width:60%;border:1px solid black;"><br>
                                <p>The members of each cluster are aggregated using their means:</p>
                                <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">         MPI Urban  Headcount Ratio Urban  Intensity of Deprivation Urban  \
cluster                                                                     
0         0.154136              33.081818                       46.459091   
1         0.007977               2.172727                       37.152273   
2         0.057926              13.588889                       42.081481   
3         0.298333              58.255556                       50.911111   

            MPI Rural  Headcount Ratio Rural  Intensity of Deprivation Rural  
cluster                                                                    
0         0.430727              77.387273                       55.477273  
1         0.031341               7.596364                       39.075000  
2         0.211593              44.770370                       46.874074  
3         0.592111              93.125556                       63.411111  
</pre></div>
<br><p>By inspection, sorting the clusters from most to least urgent areas of poverty results in the numbering: three, one, two, zero. This numbering can be used to devise a targeted relief strategy.</p>
                            </div>
                        </div>
                            
                            <div class="card-header" id="headingThree">
                            <h5 class="mb-0">
                                <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                                Applying non-negative matrix factorisation to wine recommer system
                                </button>
                            </h5>
                        </div>
                        <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionExample">
                            <div class="card-body">
                                <p style="font-weight:bold;">The Problem:</p>
                                <p>Recommender systems are in high demand. Non-negative matrix factorisation (NMF) is a data reduction technique that "learns" features of a dataset in an unsupervised ensemble. For text data, the features are topics. Thus, NMF is suitable for implementation in text-based recommender systems. In particular, my task was to create a program that recommends wines given your preferred wine choice from a <a href="https://www.kaggle.com/zynicide/wine-reviews/home">dataset</a> scraped from the <a href="https://www.winemag.com/?s=&drink_type=wine">WineEnthusiast</a>.</p>
                                <p style="font-weight:bold;">The Code:</p>
                                <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #408080; font-style: italic"># -*- coding: utf-8 -*-</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>
<span style="color: #BA2121; font-style: italic">Created on 30/11/2017 18:37:21</span>

<span style="color: #BA2121; font-style: italic">@author: Ramin Tawab</span>
<span style="color: #BA2121; font-style: italic">&quot;&quot;&quot;</span>

<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">pandas</span> <span style="color: #008000; font-weight: bold">as</span> <span style="color: #0000FF; font-weight: bold">pd</span>
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">nltk.stem.snowball</span> <span style="color: #008000; font-weight: bold">import</span> SnowballStemmer
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">nltk.corpus</span> <span style="color: #008000; font-weight: bold">import</span> stopwords
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.feature_extraction.text</span> <span style="color: #008000; font-weight: bold">import</span> TfidfVectorizer
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.decomposition</span> <span style="color: #008000; font-weight: bold">import</span> NMF
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">sklearn.preprocessing</span> <span style="color: #008000; font-weight: bold">import</span> normalize

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">formatter</span>(s):
    <span style="color: #BA2121">&#39;string preprocesing pipeline for text analysis&#39;</span>
    formatted <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span><span style="color: #666666">.</span>join([i <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> s<span style="color: #666666">.</span>lower() <span style="color: #008000; font-weight: bold">if</span> i<span style="color: #666666">.</span>isalpha() <span style="color: #AA22FF; font-weight: bold">or</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #BA2121">&quot; &#39;&quot;</span>])<span style="color: #666666">.</span>split()
    formatted <span style="color: #666666">=</span> [i <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> formatted <span style="color: #008000; font-weight: bold">if</span> i <span style="color: #AA22FF; font-weight: bold">not</span> <span style="color: #AA22FF; font-weight: bold">in</span> stopwords<span style="color: #666666">.</span>words(<span style="color: #BA2121">&#39;english&#39;</span>)]
    stemmer <span style="color: #666666">=</span> SnowballStemmer(<span style="color: #BA2121">&quot;english&quot;</span>)
    formatted <span style="color: #666666">=</span> [stemmer<span style="color: #666666">.</span>stem(i) <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> formatted]
    <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&#39; &#39;</span><span style="color: #666666">.</span>join(formatted)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">getDataFrame</span>():
    <span style="color: #BA2121">&#39;parse data into pandas dataframe&#39;</span>
    data <span style="color: #666666">=</span> pd<span style="color: #666666">.</span>read_csv(<span style="color: #BA2121">&#39;C:/Users/user/Downloads/wine/wine.csv&#39;</span>)
    df <span style="color: #666666">=</span> pd<span style="color: #666666">.</span>DataFrame(data)
    <span style="color: #008000; font-weight: bold">return</span> df<span style="color: #666666">.</span>iloc[:<span style="color: #666666">100</span>,:] <span style="color: #408080; font-style: italic"># limit to 100 rows for speed</span>
    
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">getCorpus</span>(Df):
    <span style="color: #BA2121">&#39;construct corpus of texts from dataframe&#39;</span>
    df <span style="color: #666666">=</span> Df[[<span style="color: #BA2121">&#39;description&#39;</span>,<span style="color: #BA2121">&#39;country&#39;</span>,<span style="color: #BA2121">&#39;province&#39;</span>,<span style="color: #BA2121">&#39;variety&#39;</span>]]
    df[<span style="color: #BA2121">&#39;metric&#39;</span>] <span style="color: #666666">=</span> df[<span style="color: #BA2121">&#39;description&#39;</span>] <span style="color: #666666">+</span> <span style="color: #BA2121">&#39; &#39;</span> <span style="color: #666666">+</span> df[<span style="color: #BA2121">&#39;country&#39;</span>] <span style="color: #666666">+</span> <span style="color: #BA2121">&#39; &#39;</span> <span style="color: #666666">+</span> df[<span style="color: #BA2121">&#39;province&#39;</span>] <span style="color: #666666">+</span> <span style="color: #BA2121">&#39; &#39;</span> <span style="color: #666666">+</span> df[<span style="color: #BA2121">&#39;variety&#39;</span>]
    <span style="color: #008000; font-weight: bold">return</span> [formatter(<span style="color: #008000">str</span>(i)) <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> df[<span style="color: #BA2121">&#39;metric&#39;</span>]<span style="color: #666666">.</span>values]

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">vectorise</span>(corpus):
    <span style="color: #BA2121">&#39;vectorise corpus of texts into tf-idf matrix&#39;</span>
    vectorizer <span style="color: #666666">=</span> TfidfVectorizer()
    <span style="color: #008000; font-weight: bold">return</span> vectorizer<span style="color: #666666">.</span>fit_transform(corpus)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">factorise</span>(vector):
    <span style="color: #BA2121">&#39;apply non-negative matrix factorisation&#39;</span>
    nmf <span style="color: #666666">=</span> NMF(n_components <span style="color: #666666">=</span> <span style="color: #666666">10</span>)
    nmf_features <span style="color: #666666">=</span> nmf<span style="color: #666666">.</span>fit_transform(vector)
    nmf_features <span style="color: #666666">=</span> normalize(nmf_features)
    <span style="color: #008000; font-weight: bold">return</span> nmf_features
        
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">main</span>(num):
    <span style="color: #BA2121">&#39;find wines most similar to wine in position num of dataset&#39;</span>
    <span style="color: #408080; font-style: italic"># construst corpus of wine reviews into tf-idf matrix</span>
    Df <span style="color: #666666">=</span> getDataFrame()
    corpus <span style="color: #666666">=</span> getCorpus(Df)
    vector <span style="color: #666666">=</span> vectorise(corpus)
    <span style="color: #408080; font-style: italic"># apply NMF to the matrix and compute dot product similarities</span>
    factor <span style="color: #666666">=</span> factorise(vector)
    factor <span style="color: #666666">=</span> [factor[num]<span style="color: #666666">.</span>dot(j) <span style="color: #008000; font-weight: bold">for</span> j <span style="color: #AA22FF; font-weight: bold">in</span> factor]
    Df[<span style="color: #BA2121">&#39;similarity&#39;</span>] <span style="color: #666666">=</span> factor
    Df <span style="color: #666666">=</span> Df<span style="color: #666666">.</span>sort_values(by<span style="color: #666666">=</span>[<span style="color: #BA2121">&#39;similarity&#39;</span>], ascending<span style="color: #666666">=</span><span style="color: #008000; font-weight: bold">False</span>)
    <span style="color: #008000; font-weight: bold">return</span> Df

factor <span style="color: #666666">=</span> main(<span style="color: #666666">0</span>)
</pre></div>
<br>
                                <p style="font-weight:bold">The Solution:</p>
                                <p>Running the above program and printing the first five lines of the resulting dataframe produces the following output:</p>
                                <!-- HTML generated using hilite.me --><div style="background: #f8f8f8; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">    Unnamed: 0 country                                        description  \
0            0   Italy  Aromas include tropical fruit, broom, brimston...   
26          26   Italy  Pretty aromas of yellow flower and stone fruit...   
22          22   Italy  Delicate aromas recall white flower and citrus...   
40          40   Italy  Catarratto is one of Sicily&#39;s most widely farm...   
52          52   Italy  The Monica grape often shows a rustic or raw q...   

        designation  points  price           province            region_1  \
0   Vulkà Bianco      87    NaN  Sicily &amp; Sardinia                Etna   
26        Dalila      87   13.0  Sicily &amp; Sardinia     Terre Siciliane   
22     Ficiligno      87   19.0  Sicily &amp; Sardinia             Sicilia   
40           NaN      86   17.0  Sicily &amp; Sardinia             Sicilia   
52         Dolia      85   14.0  Sicily &amp; Sardinia  Monica di Sardegna   

    region_2    taster_name taster_twitter_handle  \
0       NaN  Kerin O’Keefe          @kerinokeefe   
26      NaN  Kerin O’Keefe          @kerinokeefe   
22      NaN  Kerin O’Keefe          @kerinokeefe   
40      NaN            NaN                   NaN   
52      NaN            NaN                   NaN   

                                                title      variety  \
0                   Nicosia 2013 Vulkà Bianco  (Etna)  White Blend   
26       Stemmari 2013 Dalila White (Terre Siciliane)  White Blend   
22  Baglio di Pianetto 2007 Ficiligno White (Sicilia)  White Blend   
40            Feudo Montoni 2011 Catarratto (Sicilia)   Catarratto   
52  Cantine di Dolianova 2010 Dolia  (Monica di Sa...       Monica   

                    winery  similarity  
0                Nicosia    1.000000  
26              Stemmari    0.935817  
22    Baglio di Pianetto    0.929746  
40         Feudo Montoni    0.925351  
52  Cantine di Dolianova    0.877521  
</pre></div><br>
<p>The similarity is computed from a factored tf-idf matrix of the wine reviews column. However, it is noteworthy that both the taster_name, the variety, the province, the points and the price are all very similar. The recommender system is very powerful considering it was written in a few lines.</p>
                            </div>
                        </div>
                            
                        </div>


                </div>
            </div>
            </div>
        </div>
</main>

<footer class="text-muted">
<div class="container">
<p class="float-right">
<a href="#">Back to top</a>
<p>&#xa9; Ramin Tawab 2018</p>
</div>
</footer>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" 
integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery-slim.min.js"><\/script>')</script>
<script src="https://getbootstrap.com/docs/4.1/assets/js/vendor/popper.min.js"></script>
<script src="https://getbootstrap.com/docs/4.1/dist/js/bootstrap.min.js"></script>
<script src="https://getbootstrap.com/docs/4.1/assets/js/vendor/holder.min.js"></script>
</body>
